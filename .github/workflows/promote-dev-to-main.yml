name: Promote Dev To Main

on:
  push:
    branches: [dev]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: promote-dev-to-main
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Create or reuse dev -> main PR
        id: promotion_pr
        env:
          GH_TOKEN: ${{ secrets.GH_AUTOMATION_TOKEN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          pr_number="$(gh pr list --repo "$REPO" --base main --head dev --state open --json number --jq '.[0].number')"

          if [ -z "${pr_number:-}" ]; then
            set +e
            create_output="$(gh pr create \
              --repo "$REPO" \
              --base main \
              --head dev \
              --title "Promote dev to main" \
              --body "Automated promotion after changes were merged into dev." 2>&1)"
            create_code=$?
            set -e

            if [ $create_code -ne 0 ]; then
              if echo "$create_output" | grep -qi "No commits between"; then
                echo "No changes to promote from dev to main."
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi

              echo "$create_output"
              exit $create_code
            fi

            pr_url="$(echo "$create_output" | tail -n1)"
            pr_number="$(echo "$pr_url" | sed -n 's#.*/pull/\([0-9]\+\).*#\1#p')"
          fi

          if [ -z "${pr_number:-}" ]; then
            echo "Could not determine promotion PR number."
            exit 1
          fi

          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "Promotion PR #$pr_number ready - merge manually after reviewing dev."
